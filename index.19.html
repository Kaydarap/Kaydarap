<!doctype html>
<html lang="fa">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Kaydarap</title>
  <meta name="description" content="Kaydarap" />
  <meta name="color-scheme" content="dark">
  <meta name="theme-color" content="#050507" />
  <!-- Dancing Script font -->
  <link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@700&display=swap" rel="stylesheet">
  <style>
    :root{ --bg0:#050507; --bg1:#0a0b0e; --bg2:#101216; --fg:#eaeaf0; --muted:#a3a3ae; --accent:#6bdcff; --glow:#6bdcff22; }
    *{box-sizing:border-box} html,body{height:100%}
    body{ margin:0; color:var(--fg);
      background: radial-gradient(120% 160% at 50% -10%, var(--bg2) 0%, var(--bg1) 40%, var(--bg0) 100%);
      color-scheme:dark; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans";
      overflow-x:hidden;
    }
    .section{ min-height:100vh; position:relative; display:grid; place-items:center; padding:0 16px; }
    .top{
      position:fixed; inset:0 0 auto 0;
      display:flex; align-items:center; gap:.75rem;
      padding:14px 18px calc(env(safe-area-inset-top) + 0px) 18px;
      pointer-events:none; z-index:10;
      transition: opacity .22s linear, transform .22s ease;
      will-change: opacity, transform;
    }
    .brand{ font-weight:700; letter-spacing:.12em; text-transform:uppercase; font-size:.95rem; color:var(--muted); opacity:.9; user-select:none; }
    .planet-wrap{ position:relative; width:86px; height:86px; filter: drop-shadow(0 0 18px var(--glow)) drop-shadow(0 0 48px var(--glow)); pointer-events:none; }
    .planet{ position:relative; width:100%; height:100%; border-radius:50%; background:
      radial-gradient(120% 120% at 30% 30%, #8ff1ff 0%, #2a9bff 25%, #0f1a3a 55%, #0b0f24 70%, #060810 100%);
      overflow:hidden; transform: translateZ(0);
    }
    .planet::before{ content:""; position:absolute; inset:-30%; border-radius:50%;
      background: radial-gradient(60% 70% at 20% 25%, rgba(0,0,0,0) 0%, rgba(0,0,0,0.0) 45%, rgba(0,0,0,.55) 70%, rgba(0,0,0,.9) 100%);
      mix-blend-mode:multiply;
    }
    .planet::after{ content:""; position:absolute; inset:-10%; border-radius:50%;
      background: conic-gradient(from 0deg, rgba(255,255,255,.08), rgba(255,255,255,0) 30% 100%);
      animation: spin 28s linear infinite; mix-blend-mode:screen;
    }
    @keyframes spin{to{transform:rotate(360deg)}}
    .ring{ position:absolute; inset:-20%; border-radius:50%;
      background: radial-gradient(60% 15% at 50% 50%, rgba(140,220,255,.35), rgba(140,220,255,0) 65%);
      transform: rotateX(70deg) rotateZ(-25deg); filter: blur(0.6px);
      animation: wobble 9s ease-in-out infinite alternate;
    }
    @keyframes wobble{ from{ transform: rotateX(68deg) rotateZ(-27deg) } to{ transform: rotateX(74deg) rotateZ(-23deg) } }

    .hero-title {
      font-family: 'Dancing Script', cursive;
      font-size: clamp(3rem, 12vw, 10rem);
      color: #ffffff;
      text-align: center;
      margin: 0;
      user-select: none;
      text-shadow: 0 4px 25px rgba(0,0,0,0.6);
    }

    .sphere-section{ min-height:100vh; position:relative; }
    .title{ position:absolute; top:18px; left:0; right:0; text-align:center; font-weight:800; letter-spacing:.02em;
      font-size: clamp(1.2rem, 2.8vw, 2rem); color:#f4fbff; text-shadow: 0 2px 20px rgba(80,170,220,.25);
      user-select:none; z-index:2;
    }
    .three-wrap{ position:absolute; inset:0; z-index:1; touch-action: pan-y; }
    canvas{ display:block; width:100%; height:100%; will-change: transform; }

    @supports (-webkit-touch-callout: none){ .sphere-section, .three-wrap { min-height: 100svh; } }
    @media (max-width:480px){ .planet-wrap{ width:72px; height:72px } .brand{ font-size:.88rem } }
  
  /* ===== Section 3: Laser/Hologram Link Cards ===== */
  .links{ min-height:100vh; display:flex; align-items:center; justify-content:center; padding:80px 16px; position:relative; }
  .links-inner{ width:min(1100px, 94vw); display:grid; grid-template-columns: 1fr 1fr; gap:24px; align-items:start; }
  .links-title{ grid-column:1/-1; text-align:center; font-weight:900; letter-spacing:.06em; color:#e9faff;
    text-shadow: 0 0 18px rgba(107,220,255,.2); margin-bottom:8px; font-size: clamp(1.4rem, 3vw, 2rem);
  }
  .links-col{ display:grid; gap:24px; }

  .laser-card{
    --cut: 14px;
    --border: #6bdcff;
    --glow: 0 0 16px rgba(107,220,255,.50), 0 0 42px rgba(107,220,255,.22);
    position:relative;
    display:flex; align-items:center; gap:14px;
    padding:18px 18px;
    color:#dff7ff; text-decoration:none;
    clip-path: polygon(var(--cut) 0, calc(100% - var(--cut)) 0, 100% var(--cut), 100% calc(100% - var(--cut)),
                      calc(100% - var(--cut)) 100%, var(--cut) 100%, 0 calc(100% - var(--cut)), 0 var(--cut));
    background: radial-gradient(120% 160% at 10% -20%, rgba(25,133,178,.35), rgba(16,24,39,.30) 46%, rgba(8,16,24,.35) 70%),
                linear-gradient(180deg, rgba(6,14,20,.55), rgba(10,16,24,.45));
    box-shadow: inset 0 0 30px rgba(98,214,255,.10), 0 10px 26px rgba(17,47,64,.35);
    backdrop-filter: blur(6px); -webkit-backdrop-filter: blur(6px);
    transition: transform .18s ease, box-shadow .18s ease, filter .18s ease;
    isolation:isolate;
  }
  .laser-card::before{
    content:""; position:absolute; inset:0; pointer-events:none;
    padding:1px; border-radius:18px;
    background: conic-gradient(from 210deg, rgba(58,186,255,.0), rgba(58,186,255,.65), rgba(58,186,255,.0) 25% 75%, rgba(58,186,255,.65), rgba(58,186,255,.0));
    -webkit-mask: linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0);
            mask: linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0);
    -webkit-mask-composite: xor; mask-composite: exclude;
    clip-path: inherit; border:1px solid transparent; filter: drop-shadow(0 0 10px rgba(107,220,255,.3));
  }
  .laser-card::after{
    content:""; position:absolute; inset:0; clip-path: inherit; pointer-events:none;
    background: radial-gradient(50% 140% at 110% -10%, rgba(107,220,255,.22), rgba(107,220,255,0) 40%);
    mix-blend-mode:screen; opacity:.9;
  }
  .laser-card:hover{ transform: translateY(-3px); box-shadow: inset 0 0 40px rgba(98,214,255,.16), 0 14px 30px rgba(25,85,115,.45); filter: saturate(1.08); }

  .laser-ico{ width:40px; height:40px; display:grid; place-items:center; flex:0 0 auto; filter: drop-shadow(0 0 12px rgba(107,220,255,.35)); }
  .laser-text{ display:grid; line-height:1.2 }
  .laser-name{ font-weight:800; letter-spacing:.02em; color:#eafaff }
  .laser-handle{ color:#bfeeff; opacity:.95; font-weight:700 }

  @media (max-width:860px){
    .links-inner{ grid-template-columns: 1fr; }
  }
</style>
</head>
<body>
  <div class="top" id="topbar">
    <div class="planet-wrap" aria-hidden="true">
      <div class="planet"><div class="ring"></div></div>
    </div>
    <div class="brand">Kaydarap</div>
  </div>

  <section class="section hero" id="hero">
    <h1 class="hero-title">Kaydarap</h1>
  </section>

  <section class="sphere-section" id="sphere">
    <div class="three-wrap" id="three-container"></div>
  </section>

  <script type="module">
    import * as THREE from "https://unpkg.com/three@0.157.0/build/three.module.js";

    const isTouch = matchMedia('(pointer: coarse)').matches;
    const topbar = document.getElementById('topbar');
    const hero = document.getElementById('hero');
    const sphereSection = document.getElementById('sphere');

    if (isTouch){
      let ticking = false;
      const onScroll = ()=>{
        if (ticking) return;
        ticking = true;
        requestAnimationFrame(()=>{
          const heroBottom = hero.offsetTop + hero.offsetHeight * 0.60;
          const sphereTop = sphereSection.offsetTop;
          const y = window.scrollY || window.pageYOffset;
          let t = (y - heroBottom) / Math.max(1, (sphereTop - heroBottom));
          t = Math.min(1, Math.max(0, t));
          const opacity = 1 - t;
          topbar.style.opacity = opacity.toFixed(3);
          topbar.style.transform = `translateY(${(-12 * t).toFixed(2)}px)`;
          ticking = false;
        });
      };
      window.addEventListener('scroll', onScroll, {passive:true});
      onScroll();
    }

    const wrap = document.getElementById('three-container');
    const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true, powerPreference: 'high-performance' });
    renderer.setPixelRatio(Math.min(devicePixelRatio, 2));
    wrap.appendChild(renderer.domElement);

    const scene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(50, 1, 0.1, 100);
    const cameraZ = 9;
    camera.position.set(0, 0, cameraZ);

    const autoGroup = new THREE.Group();
    const interGroup = new THREE.Group();
    autoGroup.add(interGroup);
    scene.add(autoGroup);
    scene.add(new THREE.AmbientLight(0x88ccff, 0.5));

    const R = 3.2, DIAM = R*2;
    const shellCount = 4800, haloCount = 4800;

    function randomOnSphere(r){
      const u = Math.random(), v = Math.random();
      const theta = 2 * Math.PI * v;
      const phi = Math.acos(2*u - 1);
      const s = Math.sin(phi);
      return new THREE.Vector3(r*s*Math.cos(theta), r*Math.cos(phi), r*s*Math.sin(theta));
    }

    const shellPositions = new Float32Array(shellCount*3);
    for(let i=0;i<shellCount;i++){ const p = randomOnSphere(R + (Math.random()-0.5)*0.02); shellPositions.set([p.x,p.y,p.z], i*3); }
    const shellGeom = new THREE.BufferGeometry();
    shellGeom.setAttribute('position', new THREE.BufferAttribute(shellPositions,3));
    interGroup.add(new THREE.Points(shellGeom, new THREE.PointsMaterial({ color:0x6bdcff, size:0.035, sizeAttenuation:true, transparent:true, opacity:0.95, blending:THREE.AdditiveBlending, depthWrite:false })));

    const haloPositions = new Float32Array(haloCount*3);
    for(let i=0;i<haloCount;i++){ const p = randomOnSphere(R*(1.04+Math.random()*0.35)); haloPositions.set([p.x,p.y,p.z], i*3); }
    const haloGeom = new THREE.BufferGeometry();
    haloGeom.setAttribute('position', new THREE.BufferAttribute(haloPositions,3));
    interGroup.add(new THREE.Points(haloGeom, new THREE.PointsMaterial({ color:0x88eeff, size:0.02, sizeAttenuation:true, transparent:true, opacity:0.55, blending:THREE.AdditiveBlending, depthWrite:false })));

    interGroup.add(new THREE.LineSegments(new THREE.WireframeGeometry(new THREE.SphereGeometry(R*0.995,32,22)), new THREE.LineBasicMaterial({color:0x3bb9ff, transparent:true, opacity:.35})));

    const orbitalGroup = new THREE.Group(); interGroup.add(orbitalGroup);
    const moon = new THREE.LineSegments(new THREE.WireframeGeometry(new THREE.SphereGeometry(0.55,24,18)), new THREE.LineBasicMaterial({color:0x9be9ff, transparent:true, opacity:.6}));
    moon.position.set(R+1.2,0,0); orbitalGroup.add(moon);

    let targetYaw=0, targetPitch=0;
    let dragging=false, rotating=false;
    let lastX=0, lastY=0, startX=0, startY=0;
    const THRESH = 8; let pointerCount=0;
    const canvas = renderer.domElement;

    canvas.addEventListener('pointerdown', e=>{
      pointerCount++;
      dragging = true;
      rotating = (pointerCount >= 2);
      if (rotating) wrap.style.touchAction='none';
      startX = lastX = e.clientX; startY = lastY = e.clientY;
      try{ canvas.setPointerCapture(e.pointerId); }catch{}
    });
    window.addEventListener('pointermove', e=>{
      if(!dragging && e.pointerType === 'mouse'){
        const x = (e.clientX / window.innerWidth) - 0.5;
        const y = (e.clientY / window.innerHeight) - 0.5;
        targetYaw = x * 0.35; targetPitch = -y * 0.35;
        return;
      }
      if(!dragging) return;
      const dx = e.clientX - lastX, dy = e.clientY - lastY;
      lastX = e.clientX; lastY = e.clientY;
      if(!rotating){
        const totalDX = Math.abs(e.clientX - startX), totalDY = Math.abs(e.clientY - startY);
        if( (totalDX > THRESH || totalDY > THRESH) && (totalDX > totalDY*1.2) ){
          rotating = true;
          wrap.style.touchAction='none';
        } else { return; }
      }
      interGroup.rotation.y += (dx / window.innerWidth) * 2.5;
      interGroup.rotation.x += (dy / window.innerHeight) * 2.5;
      if (e.cancelable) e.preventDefault();
    }, {passive:false});
    window.addEventListener('pointerup', e=>{
      pointerCount = Math.max(0, pointerCount-1);
      dragging=false; rotating=false;
      try{ canvas.releasePointerCapture(e.pointerId); }catch{}
      wrap.style.touchAction='pan-y';
    });

    function computeScaleToFit(){
      const w = wrap.clientWidth || window.innerWidth;
      const h = wrap.clientHeight || window.innerHeight;
      const aspect = w/h;
      const vFOV = THREE.MathUtils.degToRad(camera.fov);
      const visibleH = 2 * Math.tan(vFOV/2) * cameraZ;
      const visibleW = visibleH * aspect;
      const margin = (h < 750) ? 0.78 : 0.85;
      return Math.min(visibleH*margin, visibleW*margin) / DIAM;
    }
    function resize(){
      const w = wrap.clientWidth || window.innerWidth;
      const h = wrap.clientHeight || window.innerHeight;
      renderer.setSize(w, h, false);
      camera.aspect = w/h;
      camera.updateProjectionMatrix();
      const s = computeScaleToFit();
      autoGroup.scale.set(s, s, s);
    }
    new ResizeObserver(resize).observe(wrap);
    window.addEventListener('orientationchange', ()=>setTimeout(resize, 250));

    // unified smooth autospin (same on mobile & desktop)
    const autoSpinY = 0.0015;
    const autoSpinX = 0.0006;

    function animate(){
      autoGroup.rotation.y += autoSpinY;
      autoGroup.rotation.x += autoSpinX;
      interGroup.rotation.y += (targetYaw - interGroup.rotation.y) * 0.08;
      interGroup.rotation.x += (targetPitch - interGroup.rotation.x) * 0.08;
      orbitalGroup.rotation.y += 0.01;
      renderer.render(scene, camera);
    }
    let rafId=0;
    function startLoops(){
      renderer.setAnimationLoop(animate);
      const tick = ()=>{ animate(); rafId = requestAnimationFrame(tick); };
      rafId = requestAnimationFrame(tick);
    }
    function stopLoops(){
      renderer.setAnimationLoop(null);
      if (rafId) cancelAnimationFrame(rafId); rafId=0;
    }
    document.addEventListener('visibilitychange', ()=>{
      if (document.visibilityState === 'visible') startLoops(); else stopLoops();
    });
    startLoops();
    resize();
  </script>

  <!-- Section 3: Laser Links -->
  <section class="links" id="links">
    <div class="links-inner">
      <div class="links-title">Connect with <span style="color:#9cecff">Kaydarap</span></div>
      <div class="links-col">
        <a class="laser-card" href="https://instagram.com/Kaydarap" target="_blank" rel="noopener">
          <div class="laser-ico" aria-hidden="true">
            <!-- Instagram icon (blue/white) -->
            <svg viewBox="0 0 24 24" width="34" height="34" fill="none" xmlns="http://www.w3.org/2000/svg">
              <rect x="3" y="3" width="18" height="18" rx="5" stroke="#6bdcff" stroke-width="1.6"/>
              <circle cx="12" cy="12" r="4.2" stroke="#a8ecff" stroke-width="1.6"/>
              <circle cx="17.2" cy="6.8" r="1.2" fill="#6bdcff"/>
            </svg>
          </div>
          <div class="laser-text"><span class="laser-name">Instagram</span><span class="laser-handle">@Kaydarap</span></div>
        </a>

        <a class="laser-card" href="https://t.me/Kaydarap" target="_blank" rel="noopener">
          <div class="laser-ico" aria-hidden="true">
            <!-- Telegram -->
            <svg viewBox="0 0 24 24" width="34" height="34" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M21 4L3.8 11.1c-.8.3-.8 1.4-.1 1.7l4.5 1.7 1.8 4.6c.3.8 1.4.8 1.7 0l1.7-4.5 4.5-8.7c.4-.9-.5-1.6-1.2-1.2z" fill="#6bdcff" opacity=".8"/>
              <path d="M9.5 14.4l1.9 4.9 1.7-4.4 4.7-9.2-11.5 8.1 3.2.6z" stroke="#a8ecff" stroke-width="1" opacity=".9"/>
            </svg>
          </div>
          <div class="laser-text"><span class="laser-name">Telegram</span><span class="laser-handle">@Kaydarap</span></div>
        </a>

        <a class="laser-card" href="https://github.com/Kaydarap" target="_blank" rel="noopener">
          <div class="laser-ico" aria-hidden="true">
            <!-- GitHub -->
            <svg viewBox="0 0 24 24" width="34" height="34" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M12 2C6.5 2 2 6.6 2 12.2c0 4.5 2.9 8.3 6.9 9.6.5.1.7-.2.7-.5v-2c-2.8.6-3.4-1.2-3.4-1.2-.5-1.2-1.1-1.6-1.1-1.6-.9-.6.1-.6.1-.6 1 .1 1.6 1 1.6 1 .9 1.6 2.5 1.1 3.1.8.1-.7.4-1.1.7-1.4-2.2-.3-4.5-1.1-4.5-5 0-1.1.4-2 1-2.7-.1-.3-.4-1.3.1-2.6 0 0 .8-.3 2.8 1 .8-.2 1.6-.3 2.4-.3s1.6.1 2.4.3c2-1.3 2.8-1 2.8-1 .5 1.3.2 2.3.1 2.6.7.7 1 1.6 1 2.7 0 3.9-2.3 4.7-4.5 5 .4.3.8 1 .8 2v3c0 .3.2.6.7.5 4-1.3 6.9-5.1 6.9-9.6C22 6.6 17.5 2 12 2z" fill="#a8ecff"/>
            </svg>
          </div>
          <div class="laser-text"><span class="laser-name">GitHub</span><span class="laser-handle">@Kaydarap</span></div>
        </a>
      </div>

      <div class="links-col">
        <a class="laser-card" href="https://wa.me/16025662108" target="_blank" rel="noopener">
          <div class="laser-ico" aria-hidden="true">
            <!-- WhatsApp -->
            <svg viewBox="0 0 24 24" width="34" height="34" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M20 11.6c0 4.6-3.8 8.4-8.4 8.4-1.5 0-2.9-.4-4.1-1.1l-3.3 1.1 1.1-3.3c-.7-1.2-1.1-2.7-1.1-4.1C4.2 7 8 3.2 12.6 3.2 16.2 3.2 20 7 20 11.6z" stroke="#6bdcff" stroke-width="1.6"/>
              <path d="M9.4 8.9c-.3.8-.1 1.8.7 3 .9 1.3 2.2 2.2 3.5 2.6.8.2 1.4.1 1.8-.2l.8-.8c.2-.2.2-.5 0-.7l-1.3-1.1c-.2-.2-.5-.1-.7.1l-.4.5c-.2.2-.5.2-.8.1-.5-.3-1.2-.8-1.7-1.4-.2-.2-.2-.6 0-.8l.4-.4c.2-.2.2-.5 0-.7l-1-1.2c-.2-.2-.5-.2-.7 0l-.9.9z" fill="#a8ecff"/>
            </svg>
          </div>
          <div class="laser-text"><span class="laser-name">WhatsApp</span><span class="laser-handle">+1 (602) 566-2108</span></div>
        </a>
        <a class="laser-card" href="mailto:Kaydarap@gmail.com" target="_blank" rel="noopener">
          <div class="laser-ico" aria-hidden="true">
            <!-- Email -->
            <svg viewBox="0 0 24 24" width="34" height="34" fill="none" xmlns="http://www.w3.org/2000/svg">
              <rect x="3" y="5" width="18" height="14" rx="2" stroke="#6bdcff" stroke-width="1.6"/>
              <path d="M4 6.5l8 6 8-6" stroke="#a8ecff" stroke-width="1.6" fill="none"/>
            </svg>
          </div>
          <div class="laser-text"><span class="laser-name">Email</span><span class="laser-handle">Kaydarap@gmail.com</span></div>
        </a>
<a class="laser-card" href="https://discord.com/users/Kaydarap" target="_blank" rel="noopener">
          <div class="laser-ico" aria-hidden="true">
            <!-- Discord -->
            <svg viewBox="0 0 24 24" width="34" height="34" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M7.1 6.3c1.6-.7 2.9-.8 2.9-.8l.2.4c-1.8.4-3 1.1-3 1.1 2.5-1.2 5.8-1.2 8.3 0 0 0-1.2-.8-3-1.1l.2-.4s1.3 0 2.9.8c0 0 1.9 2 2.1 6.1 0 0-1.2 2-4.3 2.1 0 0-.5-.6-.9-1.1 1.8-.5 2.5-1.4 2.5-1.4-.6.4-1.2.6-1.8.8-.8.3-1.5.4-2.2.4s-1.4-.1-2.2-.4c-.6-.2-1.2-.5-1.8-.8 0 0 .7.9 2.5 1.4-.4.5-.9 1.1-.9 1.1-3.1-.1-4.3-2.1-4.3-2.1.2-4.1 2.1-6.1 2.1-6.1z" fill="#a8ecff"/>
              <circle cx="9.6" cy="11.3" r="1.1" fill="#0a1828"/>
              <circle cx="14.4" cy="11.3" r="1.1" fill="#0a1828"/>
            </svg>
          </div>
          <div class="laser-text"><span class="laser-name">Discord</span><span class="laser-handle">@Kaydarap</span></div>
        </a>
      </div>
    </div>
  </section>


<!-- ===== Section 4: Neural HUD (Robust, Non-Module) ===== -->
<section id="page4-neural" class="neural-section" aria-label="Neural HUD">
  <div class="neural-wrap">
    <canvas id="neural-canvas"></canvas>
  </div>
</section>

<style>
  .neural-section{ position:relative; min-height:100vh; }
  .neural-wrap{ position:relative; width:100%; height:100vh; }
  #neural-canvas{ display:block; width:100%; height:100%; outline:none; }
  @supports (-webkit-touch-callout:none){ .neural-wrap{ height:100svh; } }
</style>

<!-- Three.js core (non-module) -->
<script src="https://cdn.jsdelivr.net/npm/three@0.157.0/build/three.min.js"></script>
<!-- OrbitControls (non-module) -->
<script src="https://cdn.jsdelivr.net/npm/three@0.157.0/examples/js/controls/OrbitControls.min.js"></script>

<script>
(function(){
  function run(){
    if (!window.THREE) return fail("THREE not loaded");
    if (!THREE.OrbitControls) return fail("OrbitControls not loaded");
    try{
      const canvas = document.getElementById('neural-canvas');
      if (!canvas) return;

      const renderer = new THREE.WebGLRenderer({ canvas, antialias:true, alpha:true, powerPreference:"high-performance" });
      renderer.setPixelRatio(Math.min(window.devicePixelRatio||1, 2));
      renderer.outputColorSpace = THREE.SRGBColorSpace;
      renderer.setClearColor(0x000000, 0);

      const scene = new THREE.Scene();
      const camera = new THREE.PerspectiveCamera(50, 16/9, 0.1, 150);
      camera.position.set(0, 0.8, 9);
      scene.fog = new THREE.Fog(0x060712, 18, 80);

      const hemi = new THREE.HemisphereLight(0x6b00ff, 0x001022, 0.4); scene.add(hemi);
      const key  = new THREE.PointLight(0xB966FF, 30, 40, 2); key.position.set(3,4,8); scene.add(key);
      const fill = new THREE.PointLight(0x00E0FF, 24, 36, 2); fill.position.set(-5,1,5); scene.add(fill);
      const rim  = new THREE.PointLight(0x8D5BFF, 18, 30, 2); rim.position.set(0,-3,-6); scene.add(rim);

      const controls = new THREE.OrbitControls(camera, renderer.domElement);
      controls.enableDamping = true; controls.dampingFactor = 0.06;
      controls.enablePan = false; controls.minDistance = 6; controls.maxDistance = 12;
      controls.autoRotate = true; controls.autoRotateSpeed = 0.7;

      // stars
      const STAR_COUNT = 2000;
      const starGeom = new THREE.BufferGeometry();
      const arr = new Float32Array(STAR_COUNT*3);
      for(let i=0;i<STAR_COUNT;i++){
        const r = 18 + Math.random()*30, th = Math.random()*Math.PI*2, ph = Math.acos(2*Math.random()-1);
        arr[i*3+0] = r*Math.sin(ph)*Math.cos(th);
        arr[i*3+1] = r*Math.cos(ph);
        arr[i*3+2] = r*Math.sin(ph)*Math.sin(th);
      }
      starGeom.setAttribute('position', new THREE.BufferAttribute(arr,3));
      const stars = new THREE.Points(starGeom, new THREE.PointsMaterial({ color:0x7b86ff, size:0.03, transparent:true, opacity:0.6, blending:THREE.AdditiveBlending, depthWrite:false }));
      scene.add(stars);

      // rings
      const rings = new THREE.Group(); scene.add(rings);
      for(let i=0;i<6;i++){
        const g = new THREE.RingGeometry(2 + i*0.6, 2.02 + i*0.6, 80);
        const m = new THREE.MeshBasicMaterial({ color:0x8855ff, transparent:true, opacity:0.18 });
        const ring = new THREE.Mesh(g,m);
        ring.rotation.x = -Math.PI/2; ring.position.y = -1.8; rings.add(ring);
      }

      // brain (impostor) - two lobes with fake noise
      const brainGroup = new THREE.Group(); scene.add(brainGroup);
      function snoise3(x,y,z){ const s = Math.sin(x*12.9898 + y*78.233 + z*37.719) * 43758.5453; return s - Math.floor(s); }
      function buildLobe(offsetX){
        const geo = new THREE.SphereGeometry(1.6, 120, 120);
        const pos = geo.attributes.position; const base = pos.array.slice();
        const mat = new THREE.MeshStandardMaterial({ color:0x9a59ff, metalness:0.15, roughness:0.45, emissive:0x3b0a7a, emissiveIntensity:0.6 });
        const mesh = new THREE.Mesh(geo, mat); mesh.position.x = offsetX;
        mesh.userData.update = (t)=>{
          const a = pos.array;
          for(let i=0;i<a.length;i+=3){
            const x0=base[i], y0=base[i+1], z0=base[i+2];
            const n = snoise3(x0*0.9 + t*0.6, y0*0.9 - t*0.5, z0*0.9 + t*0.4);
            const s = 1.0 + (n-0.5)*0.15 + Math.sin((x0+y0+z0)*0.8 + t*1.2)*0.02;
            a[i]=x0*s; a[i+1]=y0*s; a[i+2]=z0*s;
          }
          pos.needsUpdate = true;
          if ((~~(t*30))%8===0) geo.computeVertexNormals();
        };
        return mesh;
      }
      const lobeL = buildLobe(-0.9), lobeR = buildLobe(0.9);
      brainGroup.add(lobeL, lobeR);
      const stem = new THREE.Mesh(new THREE.CapsuleGeometry(0.25, 0.8, 8, 20),
                                  new THREE.MeshStandardMaterial({ color:0x7b40ff, metalness:0.2, roughness:0.5, emissive:0x2b0a5a, emissiveIntensity:0.7 }));
      stem.position.set(0,-1.7,0); brainGroup.add(stem);
      brainGroup.rotation.set(0.25, 0.2, 0);

      // HUDs
      const hudGroup = new THREE.Group(); scene.add(hudGroup);
      function makeHUD(w,h,kind){
        const c = document.createElement('canvas'); c.width=w; c.height=h;
        const ctx = c.getContext('2d');
        const tex = new THREE.CanvasTexture(c); tex.colorSpace = THREE.SRGBColorSpace; tex.anisotropy = 4;
        const mat = new THREE.MeshBasicMaterial({ map:tex, transparent:true });
        const mesh = new THREE.Mesh(new THREE.PlaneGeometry(3.1,1.7), mat);
        mesh.userData = { ctx, c, tex, t: Math.random()*100, kind };
        return mesh;
      }
      const kinds = ['bars','lines','grid','stats','lines','bars'];
      for(let i=0;i<6;i++){
        const hud = makeHUD(512, 300, kinds[i]);
        const angle = i/6*Math.PI*2, radius = 6.6;
        hud.position.set(Math.cos(angle)*radius, (i%2?0.8:-0.2), Math.sin(angle)*radius);
        hud.lookAt(0,0.5,0);
        hudGroup.add(hud);
      }
      function drawHUD(m, t){
        const ctx = m.userData.ctx, c = m.userData.c; m.userData.t += 0.02;
        ctx.clearRect(0,0,c.width,c.height);
        const grad = ctx.createLinearGradient(0,0,c.width,c.height);
        grad.addColorStop(0,"rgba(10,10,26,0.85)"); grad.addColorStop(1,"rgba(30,10,46,0.6)");
        ctx.fillStyle = grad; ctx.fillRect(0,0,c.width,c.height);
        ctx.strokeStyle = "rgba(173,121,255,0.9)"; ctx.lineWidth=3; ctx.strokeRect(8,8,c.width-16,c.height-16);
        const tt = m.userData.t;
        if(m.userData.kind==='bars'){
          const n=10, bw=(c.width-80)/n;
          for(let i=0;i<n;i++){ const h=(Math.sin(tt*1.3+i*0.6)+1)*0.5*(c.height-90)+28;
            ctx.fillStyle = i%2? "rgba(94,255,210,0.9)" : "rgba(149,164,255,0.9)";
            ctx.fillRect(40+i*bw, c.height-40-h, bw*0.6, h);
          }
        }else if(m.userData.kind==='lines'){
          ctx.strokeStyle="rgba(149,164,255,0.95)"; ctx.lineWidth=2; ctx.beginPath();
          for(let x=20;x<c.width-20;x+=6){ const y=c.height*0.5 + Math.sin((x/40)+tt*1.4)*50 + Math.sin((x/23)-tt*0.8)*22; x===20?ctx.moveTo(x,y):ctx.lineTo(x,y); }
          ctx.stroke(); ctx.strokeStyle="rgba(94,255,210,0.9)"; ctx.beginPath();
          for(let x=20;x<c.width-20;x+=6){ const y=c.height*0.55 + Math.cos((x/35)-tt*1.1)*40; x===20?ctx.moveTo(x,y):ctx.lineTo(x,y); }
          ctx.stroke();
        }else if(m.userData.kind==='grid'){
          ctx.strokeStyle="rgba(130,130,200,0.25)"; ctx.lineWidth=1;
          for(let x=20;x<c.width-20;x+=20){ ctx.beginPath(); ctx.moveTo(x,20); ctx.lineTo(x,c.height-20); ctx.stroke(); }
          for(let y=20;y<c.height-20;y+=20){ ctx.beginPath(); ctx.moveTo(20,y); ctx.lineTo(c.width-20,y); ctx.stroke(); }
          for(let i=0;i<60;i++){ const x=30+(i*17 + (tt*120)%(c.width-80)); const y=40+(Math.sin(i*0.6+tt)*0.5+0.5)*(c.height-100);
            ctx.fillStyle="rgba(149,164,255,0.95)"; ctx.fillRect((x%(c.width-60)), y, 3, 3);
          }
        }else if(m.userData.kind==='stats'){
          ctx.fillStyle="rgba(149,164,255,0.95)"; ctx.font="bold 28px ui-monospace, Menlo, monospace";
          ctx.fillText("NEURAL LINK", 26, 46); ctx.font="bold 18px ui-monospace, Menlo, monospace";
          const v1=(Math.sin(tt*1.3)+1)*50|0, v2=(Math.cos(tt*1.1)+1)*50|0, v3=(Math.sin(tt*0.9 - 1)+1)*50|0;
          ctx.fillText("alpha: "+(50+v1)+"%", 26, 90);
          ctx.fillText("beta : "+(50+v2)+"%", 26, 120);
          ctx.fillText("gamma: "+(50+v3)+"%", 26, 150);
        }
        m.userData.tex.needsUpdate = true;
      }

      function resize(){
        const w = canvas.clientWidth || window.innerWidth;
        const h = canvas.clientHeight || window.innerHeight;
        renderer.setSize(w,h,false); camera.aspect = w/h; camera.updateProjectionMatrix();
      }
      new ResizeObserver(resize).observe(canvas);
      window.addEventListener('orientationchange', ()=>setTimeout(resize, 250));

      const clock = new THREE.Clock();
      function loop(){
        const t = clock.getElapsedTime();
        lobeL.userData.update(t); lobeR.userData.update(t);
        brainGroup.rotation.y += 0.0035; brainGroup.position.y = Math.sin(t*1.1)*0.06;
        stars.rotation.y += 0.0006;
        rings.children.forEach((r,i)=> r.material.opacity = 0.12 + Math.sin(t*1.2 + i*0.6)*0.08 );
        hudGroup.children.forEach(h => { h.rotation.y += Math.sin(t*0.3 + h.position.x)*0.0007; drawHUD(h, t); });
        controls.update();
        renderer.render(scene, camera);
        requestAnimationFrame(loop);
      }
      resize(); loop();
    }catch(e){ fail(e.message||String(e)); }
  }

  function fail(msg){
    // Try a fallback CDN for OrbitControls once
    if (!window.__oc_retry){
      window.__oc_retry = true;
      const s = document.createElement('script');
      s.src = "https://unpkg.com/three@0.157.0/examples/js/controls/OrbitControls.min.js";
      s.onload = run;
      s.onerror = function(){ showError(msg || "OrbitControls failed to load"); };
      document.currentScript.after(s);
    }else{
      showError(msg);
    }
  }

  function showError(msg){
    const el = document.createElement('div');
    el.style.position='absolute'; el.style.inset='20px'; el.style.color='#fff';
    el.style.fontFamily='ui-monospace, Menlo, monospace';
    el.style.background='rgba(0,0,0,.4)'; el.style.padding='12px 14px'; el.style.border='1px solid rgba(255,255,255,.2)';
    el.innerText = 'Error initializing 3D: ' + msg;
    document.getElementById('page4-neural').appendChild(el);
  }

  // Run after current scripts
  if (document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', run);
  }else{
    run();
  }
})();
</script>
<!-- ===== END PAGE 4 ROBUST ===== -->

</body>
</html>
