<!doctype html>
<html lang="fa">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Kaydarap</title>
  <meta name="color-scheme" content="dark">
  <meta name="theme-color" content="#050507" />
  <style>
    body{margin:0;background:#050507;color:#fff;font-family:sans-serif;overflow-x:hidden}
    .section{min-height:100vh;display:grid;place-items:center}
    .hero-title{font-size:clamp(3rem,12vw,10rem);color:#fff;margin:0}
    #page4-3d{position:relative;min-height:100svh;display:grid;place-items:center;
      background: radial-gradient(120% 160% at 50% 65%, #120b20 0%, #0c0616 60%, #05070c 100%);
      overflow:hidden;user-select:none;touch-action:none;}
    #page4-3d canvas{position:absolute;inset:0;width:100%;height:100%;display:block}
    #page4-3d .k4-hint{position:absolute;bottom:12px;left:50%;transform:translateX(-50%);
      font-size:12px;color:#f4eaff;opacity:.75;padding:6px 10px;border-radius:8px;backdrop-filter:blur(6px)}
  </style>
</head>
<body>
  <section class="section hero"><h1 class="hero-title">Kaydarap</h1></section>

  <!-- سکشن ۴: مغز سه‌بعدی بنفش -->
  <section id="page4-3d"><div class="k4-hint">بچرخانید / زوم کنید</div></section>

  <script type="module">
    import * as THREE from 'https://unpkg.com/three@0.157.0/build/three.module.js';
    import { OrbitControls } from 'https://unpkg.com/three@0.157.0/examples/jsm/controls/OrbitControls.js';
    import { ImprovedNoise } from 'https://unpkg.com/three@0.157.0/examples/jsm/math/ImprovedNoise.js';

    const container=document.getElementById('page4-3d');
    const scene=new THREE.Scene();
    const camera=new THREE.PerspectiveCamera(55,1,0.1,200);
    camera.position.set(0,0.6,7.2);
    const renderer=new THREE.WebGLRenderer({antialias:true,alpha:true});
    renderer.outputColorSpace=THREE.SRGBColorSpace;container.appendChild(renderer.domElement);
    function resize(){const w=container.clientWidth||innerWidth,h=container.clientHeight||innerHeight;
      renderer.setPixelRatio(Math.min(window.devicePixelRatio,2));renderer.setSize(w,h,false);
      camera.aspect=w/h;camera.updateProjectionMatrix()}resize();new ResizeObserver(resize).observe(container);

    // Lights purple
    scene.add(new THREE.AmbientLight(0xD9B3FF,0.6));
    const key=new THREE.PointLight(0xCFA8FF,26,60);key.position.set(4,5,6);scene.add(key);
    const rim=new THREE.PointLight(0x9C6BFF,18,60);rim.position.set(-6,2,-4);scene.add(rim);

    const controls=new OrbitControls(camera,renderer.domElement);
    controls.enableDamping=true;controls.dampingFactor=0.06;
    controls.minDistance=4.3;controls.maxDistance=12;controls.maxPolarAngle=Math.PI*0.62;
    controls.target.set(0,0.3,0);

    const group=new THREE.Group();scene.add(group);
    const noise=new ImprovedNoise();const baseRadius=1.45,subdiv=6,amp=0.22;
    const mat=new THREE.MeshStandardMaterial({color:0xE9D5FF,roughness:0.28,metalness:0.35,
      emissive:0x7A2CFF,emissiveIntensity:0.55});

    function lobe(dx){const g=new THREE.IcosahedronGeometry(baseRadius,subdiv);
      const pos=g.attributes.position;const origin=new Float32Array(pos.array.length);origin.set(pos.array);
      const m=new THREE.Mesh(g,mat.clone());m.userData.origin=origin;m.position.x=dx;m.scale.x=.92;return m;}
    const left=lobe(-.17),right=lobe(.17);group.add(left,right);
    const stem=new THREE.Mesh(new THREE.CapsuleGeometry(.22,.6,6,14),mat.clone());
    stem.material.emissiveIntensity=0.45;stem.position.set(0,-1.25,0);stem.rotation.z=.1;group.add(stem);

    // Rings purple
    const rings=new THREE.Group();scene.add(rings);
    for(let i=0;i<6;i++){const r=2.2+i*.25;
      const t=new THREE.Mesh(new THREE.TorusGeometry(r,.02+i*.004,32,128),
        new THREE.MeshBasicMaterial({color:0xB889FF,transparent:true,opacity:.5-i*.05}));
      t.rotation.x=Math.PI/2;t.position.y=-2.1+i*.12;rings.add(t)}

    // HUD simple purple
    const hudGroup=new THREE.Group();scene.add(hudGroup);
    function makeHUD(w=200,h=100){const cvs=document.createElement('canvas');cvs.width=w;cvs.height=h;
      const ctx=cvs.getContext('2d');const tex=new THREE.CanvasTexture(cvs);tex.colorSpace=THREE.SRGBColorSpace;
      const mesh=new THREE.Mesh(new THREE.PlaneGeometry(2,1),new THREE.MeshBasicMaterial({map:tex,transparent:true,opacity:.9}));
      mesh.userData={cvs,ctx,tex};return mesh}
    const hud=makeHUD();hud.position.set(0,1.5,-3.5);hud.lookAt(0,0.6,0);hudGroup.add(hud);
    function drawHUD(mesh,t){const {cvs,ctx,tex}=mesh.userData;const w=cvs.width,h=cvs.height;
      ctx.clearRect(0,0,w,h);ctx.strokeStyle='rgba(184,137,255,0.95)';ctx.lineWidth=3;ctx.strokeRect(6,6,w-12,h-12);
      ctx.font='bold 16px sans-serif';ctx.fillStyle='#fff';ctx.fillText('Neural Telemetry',12,24);tex.needsUpdate=true}

    const clock=new THREE.Clock();const tmp=new THREE.Vector3();
    function updateLobe(mesh,t){const g=mesh.geometry,pos=g.attributes.position,origin=mesh.userData.origin;
      for(let i=0;i<pos.count;i++){tmp.fromArray(origin,i*3);
        const n=noise.noise(tmp.x+t*.3,tmp.y+t*.35,tmp.z-t*.25);
        const k=amp*(0.6+0.4*Math.sin(t*.8+i*0.37));tmp.multiplyScalar(1+n*k);pos.setXYZ(i,tmp.x,tmp.y,tmp.z)}
      pos.needsUpdate=true;g.computeVertexNormals()}
    function animate(){const t=clock.getElapsedTime();
      updateLobe(left,t);updateLobe(right,t+100);stem.rotation.y=Math.sin(t*.4)*.08;
      drawHUD(hud,t);group.rotation.y+=.0018;controls.update();renderer.render(scene,camera);
      requestAnimationFrame(animate)}animate();
  </script>
</body>
</html>
