<!doctype html>
<html lang="fa">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Kaydarap</title>
  <meta name="description" content="Kaydarap" />
  <meta name="color-scheme" content="dark">
  <meta name="theme-color" content="#050507" />
  <link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@700&display=swap" rel="stylesheet">
  <style>
    :root{ --bg0:#050507; --bg1:#0a0b0e; --bg2:#101216; --fg:#eaeaf0; --muted:#a3a3ae; --accent:#6bdcff; --glow:#6bdcff22; }
    *{box-sizing:border-box} html,body{height:100%}
    body{ margin:0; color:var(--fg);
      background: radial-gradient(120% 160% at 50% -10%, var(--bg2) 0%, var(--bg1) 40%, var(--bg0) 100%);
      color-scheme:dark; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans";
      overflow-x:hidden;
    }
    .section{ min-height:100vh; position:relative; display:grid; place-items:center; padding:0 16px; }
    .top{ position:fixed; inset:0 0 auto 0; display:flex; align-items:center; gap:.75rem; padding:14px 18px calc(env(safe-area-inset-top) + 0px) 18px; pointer-events:none; z-index:10; }
    .brand{ font-weight:700; letter-spacing:.12em; text-transform:uppercase; font-size:.95rem; color:var(--muted); opacity:.9; user-select:none; }
    .planet-wrap{ position:relative; width:86px; height:86px; filter: drop-shadow(0 0 18px var(--glow)) drop-shadow(0 0 48px var(--glow)); pointer-events:none; }
    .planet{ position:relative; width:100%; height:100%; border-radius:50%; background: radial-gradient(120% 120% at 30% 30%, #8ff1ff 0%, #2a9bff 25%, #0f1a3a 55%, #0b0f24 70%, #060810 100%); overflow:hidden; transform: translateZ(0); }
    .planet::before{ content:""; position:absolute; inset:-30%; border-radius:50%; background: radial-gradient(60% 70% at 20% 25%, rgba(0,0,0,0) 0%, rgba(0,0,0,0.0) 45%, rgba(0,0,0,.55) 70%, rgba(0,0,0,.9) 100%); mix-blend-mode:multiply; }
    .planet::after{ content:""; position:absolute; inset:-10%; border-radius:50%; background: conic-gradient(from 0deg, rgba(255,255,255,.08), rgba(255,255,255,0) 30% 100%); animation: spin 28s linear infinite; mix-blend-mode:screen; }
    @keyframes spin{to{transform:rotate(360deg)}}
    .ring{ position:absolute; inset:-20%; border-radius:50%; background: radial-gradient(60% 15% at 50% 50%, rgba(140,220,255,.35), rgba(140,220,255,0) 65%); transform: rotateX(70deg) rotateZ(-25deg); filter: blur(0.6px); animation: wobble 9s ease-in-out infinite alternate; }
    @keyframes wobble{ from{ transform: rotateX(68deg) rotateZ(-27deg) } to{ transform: rotateX(74deg) rotateZ(-23deg) } }
    .hero-title { font-family: 'Dancing Script', cursive; font-size: clamp(3rem, 12vw, 10rem); color: #ffffff; text-align: center; margin: 0; user-select: none; text-shadow: 0 4px 25px rgba(0,0,0,0.6); }
    .sphere-section{ min-height:100vh; position:relative; }
    .title{ position:absolute; top:32px; left:0; right:0; text-align:center; font-weight:800; letter-spacing:.02em; font-size: clamp(1.2rem, 2.8vw, 2rem); color:#f4fbff; text-shadow: 0 2px 20px rgba(80,170,220,.25); user-select:none; z-index:2; }
    .three-wrap{ position:absolute; inset:0; z-index:1; touch-action: pan-y; } /* allow vertical scroll by default */
    canvas{ display:block; width:100%; height:100%; }
    @supports (-webkit-touch-callout: none){ .sphere-section, .three-wrap { min-height: 100svh; } }
    @media (max-width:480px){ .planet-wrap{ width:72px; height:72px } .brand{ font-size:.88rem } }
  </style>
</head>
<body>
  <div class="top">
    <div class="planet-wrap" aria-hidden="true">
      <div class="planet"><div class="ring"></div></div>
    </div>
    <div class="brand">Kaydarap</div>
  </div>

  <section class="section hero">
    <h1 class="hero-title">Kaydarap</h1>
  </section>

  <section class="sphere-section" id="sphere">
    <div class="title">Welcome to Kaydarap Website</div>
    <div class="three-wrap" id="three-container"></div>
  </section>

  <script type="module">
    import * as THREE from "https://unpkg.com/three@0.157.0/build/three.module.js";

    const wrap = document.getElementById('three-container');
    const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true, powerPreference: 'high-performance' });
    renderer.setPixelRatio(Math.min(devicePixelRatio, 2));
    wrap.appendChild(renderer.domElement);

    const scene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(50, 1, 0.1, 100);
    const cameraZ = 9;
    camera.position.set(0, 0, cameraZ);

    const group = new THREE.Group();
    scene.add(group);
    scene.add(new THREE.AmbientLight(0x88ccff, 0.5));

    const R = 3.2, DIAM = R*2;
    const shellCount = 4800, haloCount = 4800;

    function randomOnSphere(r){
      const u = Math.random(), v = Math.random();
      const theta = 2 * Math.PI * v;
      const phi = Math.acos(2*u - 1);
      const s = Math.sin(phi);
      return new THREE.Vector3(r*s*Math.cos(theta), r*Math.cos(phi), r*s*Math.sin(theta));
    }

    // shell
    const shellPositions = new Float32Array(shellCount*3);
    for(let i=0;i<shellCount;i++){ const p = randomOnSphere(R + (Math.random()-0.5)*0.02); shellPositions.set([p.x,p.y,p.z], i*3); }
    const shellGeom = new THREE.BufferGeometry();
    shellGeom.setAttribute('position', new THREE.BufferAttribute(shellPositions,3));
    group.add(new THREE.Points(shellGeom, new THREE.PointsMaterial({ color:0x6bdcff, size:0.035, sizeAttenuation:true, transparent:true, opacity:0.95, blending:THREE.AdditiveBlending, depthWrite:false })));

    // halo
    const haloPositions = new Float32Array(haloCount*3);
    for(let i=0;i<haloCount;i++){ const p = randomOnSphere(R*(1.04+Math.random()*0.35)); haloPositions.set([p.x,p.y,p.z], i*3); }
    const haloGeom = new THREE.BufferGeometry();
    haloGeom.setAttribute('position', new THREE.BufferAttribute(haloPositions,3));
    group.add(new THREE.Points(haloGeom, new THREE.PointsMaterial({ color:0x88eeff, size:0.02, sizeAttenuation:true, transparent:true, opacity:0.55, blending:THREE.AdditiveBlending, depthWrite:false })));

    // wire
    group.add(new THREE.LineSegments(new THREE.WireframeGeometry(new THREE.SphereGeometry(R*0.995,32,22)), new THREE.LineBasicMaterial({color:0x3bb9ff, transparent:true, opacity:.35})));

    // moon orbit
    const orbitalGroup = new THREE.Group(); group.add(orbitalGroup);
    const moon = new THREE.LineSegments(new THREE.WireframeGeometry(new THREE.SphereGeometry(0.55,24,18)), new THREE.LineBasicMaterial({color:0x9be9ff, transparent:true, opacity:.6}));
    moon.position.set(R+1.2,0,0); orbitalGroup.add(moon);

    // ---------------- Interactions ----------------
    let targetX=0, targetY=0;              // parallax targets
    let dragging=false, rotating=false;
    let lastX=0, lastY=0, startX=0, startY=0;
    const THRESH = 8; // px

    const canvas = renderer.domElement; // attach events directly to canvas (reliable on all browsers)

    function beginDrag(x,y){
      dragging=true; rotating=false; startX=lastX=x; startY=lastY=y;
    }
    function moveDrag(x,y,preventDefault){
      if(!dragging) return;
      const dx = x - lastX, dy = y - lastY;
      lastX = x; lastY = y;

      if(!rotating){
        const totalDX = Math.abs(x - startX), totalDY = Math.abs(y - startY);
        if( (totalDX > THRESH || totalDY > THRESH) && (totalDX > totalDY*1.2) ){
          rotating = true;
          // disable scroll during rotation on touch
          document.getElementById('three-container').style.touchAction = 'none';
        } else { return; }
      }
      group.rotation.y += (dx / window.innerWidth) * 2.5;
      group.rotation.x += (dy / window.innerHeight) * 2.5;
      if(preventDefault) preventDefault();
    }
    function endDrag(){
      dragging=false; rotating=false;
      document.getElementById('three-container').style.touchAction = 'pan-y';
    }

    // Mouse
    canvas.addEventListener('mousedown', e=>beginDrag(e.clientX,e.clientY));
    window.addEventListener('mousemove', e=>moveDrag(e.clientX,e.clientY, ()=>e.preventDefault()));
    window.addEventListener('mouseup', endDrag);

    // Touch
    canvas.addEventListener('touchstart', e=>{
      if(e.touches.length===1){ const t=e.touches[0]; beginDrag(t.clientX,t.clientY); }
    }, {passive:true});
    canvas.addEventListener('touchmove', e=>{
      if(e.touches.length>=2){
        // two-finger = force rotate
        const t1=e.touches[0], t2=e.touches[1];
        const cx=(t1.clientX+t2.clientX)/2, cy=(t1.clientY+t2.clientY)/2;
        rotating=true;
        document.getElementById('three-container').style.touchAction='none';
        moveDrag(cx,cy, ()=>e.preventDefault());
      } else if(e.touches.length===1){
        const t=e.touches[0];
        moveDrag(t.clientX,t.clientY, ()=>e.preventDefault());
      }
    }, {passive:false});
    canvas.addEventListener('touchend', endDrag, {passive:true});
    canvas.addEventListener('touchcancel', endDrag, {passive:true});

    // mousemove parallax (subtle)
    window.addEventListener('mousemove', e=>{
      const x = (e.clientX / window.innerWidth) - 0.5;
      const y = (e.clientY / window.innerHeight) - 0.5;
      targetX = x * 0.35; targetY = y * 0.35;
    }, {passive:true});

    // gyro (optional)
    let gyroActive=false;
    async function tryEnableGyro(){
      if (gyroActive) return;
      const D = window.DeviceOrientationEvent;
      if (!D) return;
      if (typeof D.requestPermission === 'function'){
        try { const res = await D.requestPermission(); if (res !== 'granted') return; } catch(e){ return; }
      }
      window.addEventListener('deviceorientation', (ev)=>{
        const gx = (ev.beta || 0) / 90, gy = (ev.gamma || 0) / 90;
        targetX = gy * 0.35; targetY = gx * 0.35;
      });
      gyroActive = true;
    }
    document.getElementById('sphere').addEventListener('click', tryEnableGyro, {once:true});

    // ---------------- Fit: FOV-based ----------------
    function computeScaleToFit(){
      const w = wrap.clientWidth || window.innerWidth;
      const h = wrap.clientHeight || window.innerHeight;
      const aspect = w/h;
      const vFOV = THREE.MathUtils.degToRad(camera.fov);
      const visibleH = 2 * Math.tan(vFOV/2) * cameraZ;
      const visibleW = visibleH * aspect;
      const margin = (h < 750) ? 0.78 : 0.85;
      return Math.min(visibleH*margin, visibleW*margin) / DIAM;
    }
    function resize(){
      const w = wrap.clientWidth || window.innerWidth;
      const h = wrap.clientHeight || window.innerHeight;
      renderer.setSize(w, h, false);
      camera.aspect = w/h;
      camera.updateProjectionMatrix();
      const s = computeScaleToFit();
      group.scale.set(s, s, s);
    }
    new ResizeObserver(resize).observe(wrap);
    window.addEventListener('orientationchange', ()=>setTimeout(resize, 250));

    // ---------------- Animation (auto spin ON) ----------------
    function animate(){
      requestAnimationFrame(animate);
      // base autospin (restored)
      group.rotation.y += 0.0018;
      group.rotation.x += 0.0008;
      // parallax follow
      group.rotation.y += (targetX - group.rotation.y) * 0.04;
      group.rotation.x += (-targetY - group.rotation.x) * 0.04;
      // moon orbit
      orbitalGroup.rotation.y += 0.01;
      renderer.render(scene, camera);
    }
    animate();
    resize();
  </script>
</body>
</html>
